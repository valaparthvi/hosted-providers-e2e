# This workflow calls the main workflow with custom variables
name: GKE-K8s-Chart-Support-E2E

on:
  workflow_dispatch: # Allow running manually on demand
    inputs:
      rancher_version:
        description: Rancher version to deploy
        required: true
        type: string
        default: 2.8.2
      k3s_version:
        description: k3s version of local cluster
        required: true
        type: string
        default: v1.27.9+k3s1
      run_k8s_chart_support_provisioning_tests:
        required: true
        default: false
        type: boolean
      run_k8s_chart_support_importing_tests:
        required: true
        default: false
        type: boolean
      destroy_runner:
        description: Destroy the auto-generated self-hosted runner
        default: true
        type: boolean
      downstream_cluster_cleanup:
        description: Cleanup downstream clusters after test
        default: true
        type: boolean
      runner_template:
        description: Runner template to use
        default: hosted-prov-e2e-ci-runner-spot-n2-highmem-16-gl-template-v1
        type: string
      k8s_upgrade_minor_version:
        required: true
        description: Downstream cluster K8s (minor) version to test
        default: 1.28
        type: string
      rancher_upgrade_version:
        description: Rancher version to upgrade for test
        default: devel/2.8
        type: string

jobs:
  gke-k8s-chart-support-e2e:
    uses: ./.github/workflows/main.yaml
    secrets: inherit
    with:
      hosted_provider: gke
      rancher_version: ${{ inputs.rancher_version }}
      k3s_version: ${{ inputs.k3s_version }}
      run_k8s_chart_support_provisioning_tests: ${{ inputs.run_k8s_chart_support_provisioning_tests == true }}
      run_k8s_chart_support_importing_tests: ${{ inputs.run_k8s_chart_support_importing_tests == true }}
      destroy_runner: ${{ inputs.destroy_runner == true }}
      runner_template: ${{ inputs.runner_template }}
      k8s_upgrade_minor_version: ${{ inputs.k8s_upgrade_minor_version }}
      rancher_upgrade_version: ${{ inputs.rancher_upgrade_version }}
      downstream_cluster_cleanup: ${{ inputs.downstream_cluster_cleanup == true || (github.event_name == 'schedule' && true) }}

